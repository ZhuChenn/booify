// All your baby boo tracks!
const tracks = [
    {
        id: 1,
        title: "she gone call me baby boo (Ice Cream Truck Remix)",
        artist: "ckeleton",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/3ktEqOgAHlE/hqdefault.jpg",
        duration: "0:55",
        youtubeId: "3ktEqOgAHlE",
        dateAdded: "Jan 22"
    },
    {
        id: 2,
        title: "she gon call me baby boo (Gravity Falls remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/nEmNkx0y3zs/hqdefault.jpg",
        duration: "0:39",
        youtubeId: "nEmNkx0y3zs",
        dateAdded: "Feb 8"
    },
    {
        id: 3,
        title: "she gon call me baby boo (Midnight Sun remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/aQtXYQeH-Jw/hqdefault.jpg",
        duration: "2:09",
        youtubeId: "aQtXYQeH-Jw",
        dateAdded: "Feb 8"
    },
    {
        id: 4,
        title: "she gon call me baby boo (Like Him remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/E8MKnqIojow/hqdefault.jpg",
        duration: "2:48",
        youtubeId: "E8MKnqIojow",
        dateAdded: "Feb 9"
    },
    {
        id: 5,
        title: "she gon call me baby boo (Feel Good remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/BFbFm4lFc_c/hqdefault.jpg",
        duration: "3:02",
        youtubeId: "BFbFm4lFc_c",
        dateAdded: "Feb 5"
    },
    {
        id: 6,
        title: "She Gon Call Me Baby Boo (Jersey Club)",
        artist: "DJ Taj ft Tricks",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/a_cwYw6VjBs/hqdefault.jpg",
        duration: "1:30",
        youtubeId: "a_cwYw6VjBs",
        dateAdded: "Nov 2"
    },
    {
        id: 7,
        title: "Baby Boo [What You Is] (Flaumix)",
        artist: "Flau'jae",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/Renc0gMvh74/hqdefault.jpg",
        duration: "1:46",
        youtubeId: "Renc0gMvh74",
        dateAdded: "Oct 28"
    },
    {
        id: 8,
        title: "She gon call me baby boo fnaf",
        artist: "trend hopppers",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/DENt3JvHnZk/hqdefault.jpg",
        duration: "0:21",
        youtubeId: "DENt3JvHnZk",
        dateAdded: "Feb 10"
    },
    {
        id: 9,
        title: "she gon call me baby boo (The Box remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/zDEiarzm4rg/hqdefault.jpg",
        duration: "3:17",
        youtubeId: "zDEiarzm4rg",
        dateAdded: "Feb 11"
    },
    {
        id: 10,
        title: "she gon call me baby boo (We Are Charlie Kirk remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/cdDzA_Rx5-E/hqdefault.jpg",
        duration: "2:29",
        youtubeId: "cdDzA_Rx5-E",
        dateAdded: "Feb 12"
    },
    {
        id: 11,
        title: "she gon call me baby boo (Thick of It remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/u_VdpIYkQLo/hqdefault.jpg",
        duration: "2:00",
        youtubeId: "u_VdpIYkQLo",
        dateAdded: "Feb 13"
    },
    {
        id: 12,
        title: "she gon call me baby boo (NOT CUTE ANYMORE remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/CPCwFTp1OOg/hqdefault.jpg",
        duration: "2:09",
        youtubeId: "CPCwFTp1OOg",
        dateAdded: "Feb 14"
    },
    {
        id: 13,
        title: "she gon call me baby boo (Kill Bill remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/984mIqvN8LE/hqdefault.jpg",
        duration: "2:31",
        youtubeId: "984mIqvN8LE",
        dateAdded: "Feb 15"
    },
    {
        id: 14,
        title: "she gon call me baby boo (Stateside remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/7c9zgEUn2qc/hqdefault.jpg",
        duration: "3:04",
        youtubeId: "7c9zgEUn2qc",
        dateAdded: "Feb 20"
    },
    {
        id: 15,
        title: "she gon call me baby boo (Sweet Boy remix)",
        artist: "William",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/zr0dXPPWfn8/hqdefault.jpg",
        duration: "2:14",
        youtubeId: "zr0dXPPWfn8",
        dateAdded: "Feb 18"
    },
    {
        id: 16,
        title: "she gon call me baby boo (Hotline Bling Remix)",
        artist: "prxnceallen",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/0m0veq3bo-s/hqdefault.jpg",
        duration: "0:40",
        youtubeId: "0m0veq3bo-s",
        dateAdded: "Feb 6"
    },
    {
        id: 17,
        title: "Gods Plan - Baby boo remix",
        artist: "taha",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/06jDiPUJDGQ/hqdefault.jpg",
        duration: "0:39",
        youtubeId: "06jDiPUJDGQ",
        dateAdded: "Feb 11"
    },
    {
        id: 18,
        title: "BABY BOO x DONT",
        artist: "prodbyraesam",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/0FF9qR9I-6M/hqdefault.jpg",
        duration: "2:04",
        youtubeId: "0FF9qR9I-6M",
        dateAdded: "Feb 11"
    },
    {
        id: 19,
        title: "Baby - Baby boo remix",
        artist: "taha",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/lANciy2UGW4/hqdefault.jpg",
        duration: "0:34",
        youtubeId: "lANciy2UGW4",
        dateAdded: "Feb 12"
    },
    {
        id: 20,
        title: "What You Is (Original)",
        artist: "YoungBoy Never Broke Again",
        album: "What You Is",
        cover: "https://img.youtube.com/vi/aDF6ardxhMc/hqdefault.jpg",
        duration: "3:46",
        youtubeId: "aDF6ardxhMc",
        dateAdded: "Sep 25"
    },
    {
        id: 21,
        title: "DaBabyBoo - Rockstar",
        artist: "oskietheboy",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/ZL0yekNDeh8/hqdefault.jpg",
        duration: "2:13",
        youtubeId: "ZL0yekNDeh8",
        dateAdded: "Feb 16"
    },
    {
        id: 22,
        title: "Stranger Thing (Baby Boo Remix)",
        artist: "Drayyix",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/NNzPhjNLlHA/hqdefault.jpg",
        duration: "1:39",
        youtubeId: "NNzPhjNLlHA",
        dateAdded: "Feb 11"
    },
    {
        id: 23,
        title: "she gon call me baby boo (agartha remix)",
        artist: "timsafn19",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/H1wnr8GJ3Vk/hqdefault.jpg",
        duration: "0:18",
        youtubeId: "H1wnr8GJ3Vk",
        dateAdded: "Feb 6"
    },
    {
        id: 24,
        title: "She gone call me baby boo (looping the rooms remix)",
        artist: "KarbineX2.0",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/EYzy0T_YrDA/hqdefault.jpg",
        duration: "0:26",
        youtubeId: "EYzy0T_YrDA",
        dateAdded: "Feb 10"
    },
    {
        id: 25,
        title: "She Gon Call Me Baby Boo (Remix)",
        artist: "Mixtious",
        album: "Baby Boo Remixes",
        cover: "https://img.youtube.com/vi/wdG_KmQfZHw/hqdefault.jpg",
        duration: "1:19",
        youtubeId: "wdG_KmQfZHw",
        dateAdded: "Jan 29"
    }
];

// Player State
let currentTrack = null;
let isPlaying = false;
let isShuffle = false;
let isRepeat = false;
let volume = 70;
let player = null;
let progressInterval = null;

// Shuffle state
let shuffleQueue = [];
let shuffleIndex = 0;
let playHistory = [];

// DOM Elements
const tracksList = document.getElementById('tracksList');
const playBtnLarge = document.getElementById('playBtnLarge');
const playPauseBtn = document.getElementById('playPauseBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const progressBar = document.getElementById('progressBar');
const progressFill = document.getElementById('progressFill');
const progressHandle = document.getElementById('progressHandle');
const timeCurrent = document.getElementById('timeCurrent');
const timeTotal = document.getElementById('timeTotal');
const nowPlayingTitle = document.getElementById('nowPlayingTitle');
const nowPlayingArtist = document.getElementById('nowPlayingArtist');
const nowPlayingCover = document.getElementById('nowPlayingCover');
const likeBtn = document.getElementById('likeBtn');
const volumeSlider = document.querySelector('.volume-slider');
const volumeFill = document.getElementById('volumeFill');
const volumeHandle = document.getElementById('volumeHandle');

// Side Panel Elements
const appContainer = document.querySelector('.app');
const nowPlayingPanel = document.getElementById('nowPlayingPanel');
const panelClose = document.getElementById('panelClose');
const panelCover = document.getElementById('panelCover');
const panelSongTitle = document.getElementById('panelSongTitle');
const panelArtist = document.getElementById('panelArtist');
const panelAlbum = document.getElementById('panelAlbum');
const panelDuration = document.getElementById('panelDuration');
const panelLikeBtn = document.getElementById('panelLikeBtn');

// Load YouTube IFrame API
function loadYouTubeAPI() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

// Called by YouTube API when ready - must be global
window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('youtube-player', {
        height: '1',
        width: '1',
        videoId: '',
        playerVars: {
            'autoplay': 0,
            'controls': 0,
            'disablekb': 1,
            'fs': 0,
            'modestbranding': 1,
            'rel': 0,
            'origin': window.location.origin
        },
        events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
            'onError': onPlayerError
        }
    });
};

function onPlayerReady(event) {
    console.log('YouTube player ready');
    player.setVolume(volume);
}

function onPlayerError(event) {
    console.log('YouTube player error:', event.data);
    // Try to play next track on error
    setTimeout(() => playNext(), 1000);
}

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
        if (isRepeat) {
            player.seekTo(0);
            player.playVideo();
        } else {
            playNext();
        }
    }
    
    if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        updatePlayPauseButton();
        startProgressUpdate();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        updatePlayPauseButton();
        stopProgressUpdate();
    }
}

// Initialize
function init() {
    loadYouTubeAPI();
    renderTracks();
    setupEventListeners();
    updateVolumeUI();
    updateSongCount();
}

// Update song count in hero
function updateSongCount() {
    const countEl = document.querySelector('.meta-count');
    if (countEl) {
        countEl.textContent = `${tracks.length} songs`;
    }
}

// Render tracks list
function renderTracks() {
    tracksList.innerHTML = tracks.map((track, index) => `
        <div class="track-row" data-id="${track.id}" onclick="playTrack(${track.id})">
            <div class="track-number-cell">
                <span class="track-num">${index + 1}</span>
                <svg class="track-play" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <div class="track-playing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="track-info">
                <div class="track-cover">
                    <img src="${track.cover}" alt="${track.title}" loading="lazy">
                </div>
                <div class="track-details">
                    <span class="track-name">${track.title}</span>
                    <span class="track-artist">${track.artist}</span>
                </div>
            </div>
            <span class="track-album-name">${track.album}</span>
            <span class="track-date-added">${track.dateAdded}</span>
            <span class="track-duration">${track.duration}</span>
        </div>
    `).join('');
}

// Setup event listeners
function setupEventListeners() {
    playBtnLarge.addEventListener('click', togglePlayPause);
    playPauseBtn.addEventListener('click', togglePlayPause);
    prevBtn.addEventListener('click', playPrevious);
    nextBtn.addEventListener('click', playNext);
    shuffleBtn.addEventListener('click', toggleShuffle);
    repeatBtn.addEventListener('click', toggleRepeat);
    likeBtn.addEventListener('click', toggleLike);
    
    progressBar.addEventListener('click', handleProgressClick);
    volumeSlider.addEventListener('click', handleVolumeClick);
    
    document.addEventListener('keydown', handleKeydown);
    
    // Panel controls
    if (panelClose) panelClose.addEventListener('click', closePanel);
    if (panelLikeBtn) panelLikeBtn.addEventListener('click', togglePanelLike);
    if (nowPlayingCover) nowPlayingCover.addEventListener('click', togglePanel);
}

// Play a specific track
function playTrack(id, addToHistory = true) {
    const track = tracks.find(t => t.id === id);
    if (!track) return;
    
    // Add current track to history before changing
    if (currentTrack && addToHistory) {
        playHistory.push(currentTrack.id);
        // Keep history limited to last 50 tracks
        if (playHistory.length > 50) {
            playHistory.shift();
        }
    }
    
    currentTrack = track;
    
    updateNowPlaying();
    updateTracksList();
    
    if (player && typeof player.loadVideoById === 'function') {
        player.loadVideoById(track.youtubeId);
        isPlaying = true;
        updatePlayPauseButton();
    } else {
        // Player not ready yet, wait and retry
        const waitForPlayer = setInterval(() => {
            if (player && typeof player.loadVideoById === 'function') {
                clearInterval(waitForPlayer);
                player.loadVideoById(track.youtubeId);
                isPlaying = true;
                updatePlayPauseButton();
            }
        }, 500);
    }
}

// Toggle play/pause
function togglePlayPause() {
    if (!currentTrack) {
        if (isShuffle) {
            generateShuffleQueue();
            playTrack(shuffleQueue[0].id);
        } else {
            playTrack(tracks[0].id);
        }
        return;
    }
    
    if (!player || typeof player.getPlayerState !== 'function') {
        console.log('Player not ready yet');
        return;
    }
    
    const state = player.getPlayerState();
    
    if (state === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        isPlaying = false;
        updatePlayPauseButton();
    } else {
        player.playVideo();
        isPlaying = true;
        updatePlayPauseButton();
    }
}

// Play previous track
function playPrevious() {
    if (!currentTrack) return;
    
    // If we have history, go back to the last played track
    if (playHistory.length > 0) {
        const prevTrackId = playHistory.pop();
        playTrack(prevTrackId, false); // Don't add to history when going back
        return;
    }
    
    // Otherwise, go to previous in order
    const currentIndex = tracks.findIndex(t => t.id === currentTrack.id);
    const prevIndex = currentIndex > 0 ? currentIndex - 1 : tracks.length - 1;
    playTrack(tracks[prevIndex].id);
}

// Play next track
function playNext() {
    if (!currentTrack) {
        if (isShuffle) {
            generateShuffleQueue();
            playTrack(shuffleQueue[0].id);
        } else {
            playTrack(tracks[0].id);
        }
        return;
    }
    
    if (isShuffle) {
        // Get next track from shuffle queue
        const nextTrack = getNextShuffleTrack();
        playTrack(nextTrack.id);
    } else {
        const currentIndex = tracks.findIndex(t => t.id === currentTrack.id);
        const nextIndex = currentIndex < tracks.length - 1 ? currentIndex + 1 : 0;
        playTrack(tracks[nextIndex].id);
    }
}

// Generate a new shuffle queue
function generateShuffleQueue() {
    // Create a copy of tracks and shuffle it
    shuffleQueue = [...tracks];
    
    // Fisher-Yates shuffle algorithm
    for (let i = shuffleQueue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffleQueue[i], shuffleQueue[j]] = [shuffleQueue[j], shuffleQueue[i]];
    }
    
    // If we have a current track, move it to the front
    if (currentTrack) {
        const currentIdx = shuffleQueue.findIndex(t => t.id === currentTrack.id);
        if (currentIdx > 0) {
            const [current] = shuffleQueue.splice(currentIdx, 1);
            shuffleQueue.unshift(current);
        }
    }
    
    shuffleIndex = 0;
}

// Get next track from shuffle queue
function getNextShuffleTrack() {
    shuffleIndex++;
    
    // If we've gone through all tracks, regenerate the queue
    if (shuffleIndex >= shuffleQueue.length) {
        generateShuffleQueue();
        shuffleIndex = 1; // Start at 1 since 0 would be the track we just played
    }
    
    return shuffleQueue[shuffleIndex];
}

// Toggle shuffle
function toggleShuffle() {
    isShuffle = !isShuffle;
    shuffleBtn.classList.toggle('active', isShuffle);
    
    // Generate shuffle queue when enabled
    if (isShuffle) {
        generateShuffleQueue();
    }
}

// Toggle repeat
function toggleRepeat() {
    isRepeat = !isRepeat;
    repeatBtn.classList.toggle('active', isRepeat);
}

// Toggle like
function toggleLike() {
    likeBtn.classList.toggle('liked');
    if (panelLikeBtn) panelLikeBtn.classList.toggle('liked');
}

// Update now playing section
function updateNowPlaying() {
    if (!currentTrack) return;
    
    // Update bottom bar
    nowPlayingTitle.textContent = currentTrack.title;
    nowPlayingArtist.textContent = currentTrack.artist;
    nowPlayingCover.querySelector('img').src = currentTrack.cover;
    timeTotal.textContent = currentTrack.duration;
    
    // Update side panel
    if (panelCover) panelCover.src = currentTrack.cover;
    if (panelSongTitle) panelSongTitle.textContent = currentTrack.title;
    if (panelArtist) panelArtist.textContent = currentTrack.artist;
    if (panelAlbum) panelAlbum.textContent = currentTrack.album;
    if (panelDuration) panelDuration.textContent = currentTrack.duration;
    
    // Open panel when track starts playing
    openPanel();
}

// Panel controls
function openPanel() {
    if (appContainer) appContainer.classList.add('panel-open');
}

function closePanel() {
    if (appContainer) appContainer.classList.remove('panel-open');
}

function togglePanel() {
    if (appContainer) appContainer.classList.toggle('panel-open');
}

function togglePanelLike() {
    if (panelLikeBtn) panelLikeBtn.classList.toggle('liked');
    if (likeBtn) likeBtn.classList.toggle('liked');
}

// Update tracks list (highlight current)
function updateTracksList() {
    document.querySelectorAll('.track-row').forEach(row => {
        const id = parseInt(row.dataset.id);
        row.classList.toggle('playing', currentTrack && id === currentTrack.id);
    });
}

// Update play/pause button
function updatePlayPauseButton() {
    const playIcon = playPauseBtn.querySelector('.play-icon');
    const pauseIcon = playPauseBtn.querySelector('.pause-icon');
    const playIconLarge = playBtnLarge.querySelector('.play-icon-large');
    const pauseIconLarge = playBtnLarge.querySelector('.pause-icon-large');
    
    if (isPlaying) {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        playIconLarge.style.display = 'none';
        pauseIconLarge.style.display = 'block';
    } else {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        playIconLarge.style.display = 'block';
        pauseIconLarge.style.display = 'none';
    }
}

// Progress update
function startProgressUpdate() {
    stopProgressUpdate();
    progressInterval = setInterval(updateProgressUI, 500);
}

function stopProgressUpdate() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

// Update progress UI
function updateProgressUI() {
    if (!player || !player.getCurrentTime || !player.getDuration) return;
    
    try {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        
        if (duration > 0) {
            const progress = (currentTime / duration) * 100;
            progressFill.style.width = `${progress}%`;
            progressHandle.style.left = `${progress}%`;
            
            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            timeCurrent.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    } catch (e) {
        // Player not ready
    }
}

// Handle progress bar click
function handleProgressClick(e) {
    if (!player || !player.getDuration) return;
    
    const rect = progressBar.getBoundingClientRect();
    const clickPosition = (e.clientX - rect.left) / rect.width;
    const duration = player.getDuration();
    
    if (duration > 0) {
        player.seekTo(clickPosition * duration, true);
    }
}

// Handle volume click
function handleVolumeClick(e) {
    const rect = volumeSlider.getBoundingClientRect();
    const clickPosition = (e.clientX - rect.left) / rect.width;
    volume = Math.max(0, Math.min(100, clickPosition * 100));
    
    if (player && player.setVolume) {
        player.setVolume(volume);
    }
    
    updateVolumeUI();
}

// Update volume UI
function updateVolumeUI() {
    volumeFill.style.width = `${volume}%`;
    volumeHandle.style.left = `${volume}%`;
}

// Handle keyboard controls
function handleKeydown(e) {
    switch (e.code) {
        case 'Space':
            e.preventDefault();
            togglePlayPause();
            break;
        case 'ArrowLeft':
            if (e.shiftKey) {
                playPrevious();
            } else if (player && player.getCurrentTime) {
                player.seekTo(Math.max(0, player.getCurrentTime() - 5), true);
            }
            break;
        case 'ArrowRight':
            if (e.shiftKey) {
                playNext();
            } else if (player && player.getCurrentTime) {
                player.seekTo(player.getCurrentTime() + 5, true);
            }
            break;
        case 'ArrowUp':
            e.preventDefault();
            volume = Math.min(100, volume + 10);
            if (player && player.setVolume) player.setVolume(volume);
            updateVolumeUI();
            break;
        case 'ArrowDown':
            e.preventDefault();
            volume = Math.max(0, volume - 10);
            if (player && player.setVolume) player.setVolume(volume);
            updateVolumeUI();
            break;
        case 'KeyM':
            if (player && player.isMuted) {
                if (player.isMuted()) {
                    player.unMute();
                } else {
                    player.mute();
                }
            }
            break;
        case 'KeyS':
            toggleShuffle();
            break;
        case 'KeyR':
            toggleRepeat();
            break;
    }
}

// === Wallet / Upgrade Modal ===
const DONATE_WALLET = 'H4ZpWFtPGQ2ab5jcgadnsYT2qj2RWKBw4wUCAJY5JWXS';
const DONATE_AMOUNT = 0.1; // SOL
const LAMPORTS_PER_SOL = 1000000000;

const upgradeBtn = document.getElementById('upgradeBtn');
const walletModalOverlay = document.getElementById('walletModalOverlay');
const walletModalClose = document.getElementById('walletModalClose');
const connectWalletBtn = document.getElementById('connectWalletBtn');
const donateBtn = document.getElementById('donateBtn');
const walletAddressEl = document.getElementById('walletAddress');
const txLink = document.getElementById('txLink');

const walletStep1 = document.getElementById('walletStep1');
const walletStep2 = document.getElementById('walletStep2');
const walletStep3 = document.getElementById('walletStep3');

let connectedWallet = null;

if (upgradeBtn) upgradeBtn.addEventListener('click', () => {
    walletModalOverlay.classList.add('active');
    // Reset to step 1 if wallet not connected
    if (!connectedWallet) {
        showStep(1);
    } else {
        showStep(2);
    }
});

if (walletModalClose) walletModalClose.addEventListener('click', () => {
    walletModalOverlay.classList.remove('active');
});

if (walletModalOverlay) walletModalOverlay.addEventListener('click', (e) => {
    if (e.target === walletModalOverlay) {
        walletModalOverlay.classList.remove('active');
    }
});

function showStep(step) {
    walletStep1.classList.toggle('hidden', step !== 1);
    walletStep2.classList.toggle('hidden', step !== 2);
    walletStep3.classList.toggle('hidden', step !== 3);
}

connectWalletBtn.addEventListener('click', async () => {
    try {
        if (!window.solana || !window.solana.isPhantom) {
            window.open('https://phantom.app/', '_blank');
            return;
        }

        const resp = await window.solana.connect();
        connectedWallet = resp.publicKey.toString();

        const short = connectedWallet.slice(0, 4) + '...' + connectedWallet.slice(-4);
        walletAddressEl.textContent = short;

        showStep(2);
    } catch (err) {
        console.error('Wallet connection failed:', err);
    }
});

donateBtn.addEventListener('click', async () => {
    try {
        if (!connectedWallet || !window.solana) return;

        donateBtn.textContent = 'Confirming...';
        donateBtn.style.opacity = '0.7';

        const connection = new solanaWeb3.Connection(
            solanaWeb3.clusterApiUrl('mainnet-beta'),
            'confirmed'
        );

        const fromPubkey = new solanaWeb3.PublicKey(connectedWallet);
        const toPubkey = new solanaWeb3.PublicKey(DONATE_WALLET);

        const transaction = new solanaWeb3.Transaction().add(
            solanaWeb3.SystemProgram.transfer({
                fromPubkey: fromPubkey,
                toPubkey: toPubkey,
                lamports: Math.floor(DONATE_AMOUNT * LAMPORTS_PER_SOL)
            })
        );

        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = fromPubkey;

        const signed = await window.solana.signAndSendTransaction(transaction);

        txLink.href = `https://solscan.io/tx/${signed.signature}`;
        showStep(3);
    } catch (err) {
        console.error('Transaction failed:', err);
        donateBtn.textContent = 'Donate 0.1 SOL';
        donateBtn.style.opacity = '1';
    }
});

// Initialize the app
init();
